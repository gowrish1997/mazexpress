import { withIronSessionApiRoute } from "iron-session/next";
import { sessionOptions } from "lib/session";
import { NextApiRequest, NextApiResponse } from "next";
import { IUser } from "@/models/user.interface";
import { db } from "@/lib/db";

export default withIronSessionApiRoute(userRoute, sessionOptions);

async function userRoute(req: NextApiRequest, res: NextApiResponse<IUser>) {
  return new Promise((resolve, reject) => {
    if (req.session.user) {
      // in a real world application you might read the user id from the session and then do a database request
      // to get more information on the user if needed

      db.select(
        "id_users",
        "first_name_users",
        "last_name_users",
        "email_users",
        "phone_users",
        "default_address_users",
        "avatar_url_users",
        "is_notifications_enabled_users",
        "is_admin_users",
        "is_logged_in_users"
      )
        .from("users")
        .where("id_users", req.session.user.id_users)
        .first()
        .then((data: any) => {
          res.json(data);
          resolve(data);
        });
    } else {
      res.json({
        id_users: 0,
        avatar_url_users: "default_user.png",
        first_name_users: "",
        last_name_users: "",
        email_users: "",
        password_users: "",
        phone_users: "",
        default_address_users: 0,
        is_admin_users: 0,
        is_logged_in_users: 0,
        is_notifications_enabled_users: 0,
      });
      resolve({
        id_users: 0,
        avatar_url_users: "default_user.png",
        first_name_users: "",
        last_name_users: "",
        email_users: "",
        password_users: "",
        phone_users: "",
        default_address_users: 0,
        is_admin_users: 0,
        is_logged_in_users: 0,
        is_notifications_enabled_users: 0,
      });
    }
  });
}
